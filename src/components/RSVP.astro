---
import { UNDANGAN_CONFIG } from '../data/config'
import OrnamentBackground from './OrnamentBackground.astro'
---

<div
  id="rsvp"
  class="angkasa_slide relative flex snap-start items-center justify-center overflow-hidden"
  data-section="rsvp"
>
  <OrnamentBackground />
  <div
    class="angkasa_inner flex h-[calc(100dvh-80px)] w-full flex-col justify-center px-6 py-6 pt-10 sm:px-6 sm:py-8"
  >
    <div
      class="blur-card animated-content flex h-full w-full max-w-[540px] flex-col justify-center rounded-3xl bg-(--inv-bg)/30 p-6 shadow-lg backdrop-blur-sm sm:p-8"
    >
      <div
        class="content-layer font-dekor-1 mx-auto w-full max-w-[420px] px-4 py-4 text-center sm:px-6"
      >
        <h3
          data-animation-class="animate__fadeInDown"
          class="ornament-item font-judul color-accent-2 border-rose-gold mb-4 inline-block border-b pb-2 text-2xl italic sm:text-3xl"
        >
          ✤ Kehadiran ✤
        </h3>

        <div
          data-animation-class="animate__zoomIn"
          class="ornament-item font-dekor-1 animate__slower mb-4 text-lg font-semibold"
        >
          Kepada Yth.
          <span
            id="rsvp-greeting-name"
            class="color-accent font-nama text-xl break-words whitespace-normal"
            >[Nama Tamu]</span
          >
        </div>

        <p
          data-animation-class="animate__fadeInUp"
          class="ornament-item font-dekor-1 animate__slower mb-8 text-sm font-medium sm:text-[15px]"
        >
          Merupakan suatu kehormatan bagi kami apabila Anda berkenan hadir untuk
          memberikan doa restu. <br />Mohon konfirmasi kehadiran melalui tombol
          di bawah ini.
        </p>

        <button
          data-animation-class="animate__fadeInUp"
          id="open-rsvp-modal-btn"
          onclick="openModal('rsvp-form-modal')"
          class="ornament-item color-accent-2 border-accent animate__delay-2s mx-auto inline-block rounded-full border px-5 py-3 text-xs font-bold uppercase shadow-inner duration-300 hover:bg-white/10 sm:text-sm"
        >
          <i class="fas fa-calendar-check mr-2"></i> Konfirmasi Kehadiran
        </button>
      </div>
    </div>
  </div>
</div>

<!-- ========================== MODAL ========================== -->

<div
  id="rsvp-form-modal"
  class="modal-backdrop fixed inset-0 z-[200] flex hidden items-center justify-center bg-white/30 p-4 py-6 opacity-0 backdrop-blur-sm transition-opacity duration-300"
>
  <div
    class="modal-content h-full max-h-[90vh] w-full scale-95 transform overflow-y-auto transition-all"
  >
    <div
      class="relative rounded-2xl bg-white p-6 text-center shadow-2xl"
      style="border:2px solid var(--inv-accent)"
    >
      <div class="space-y-4 text-left">
        <div>
          <label class="mb-1 block text-sm"
            >Nama Anda: <span class="text-red-500">*</span></label
          >
          <input
            id="rsvp-name-modal"
            type="text"
            class="mt-1 block w-full rounded-xl border border-[var(--inv-border)] bg-white/30 px-3 py-2 shadow-sm backdrop-blur-sm"
            placeholder="Nama Anda"
          />
        </div>

        <!-- ================= CUSTOM SELECT ================= -->
        <div>
          <label class="mb-1 block text-sm font-bold"
            >Apakah Anda akan hadir?</label
          >

          <div class="custom-select-wrapper relative">
            <div
              id="status-dropdown"
              class="custom-select-display rounded-xl border border-[var(--inv-border)]"
            >
              <span id="status-text">Hadir</span>
              <i class="fa-solid fa-chevron-down arrow-icon"></i>
            </div>

            <div id="status-options" class="custom-select-options hidden">
              <div class="option-item" data-value="Hadir">
                Ya, saya akan hadir
              </div>
              <div class="option-item" data-value="Tidak Hadir">
                Mohon maaf, saya tidak bisa hadir
              </div>
            </div>

            <!-- Hidden real value -->
            <input type="hidden" id="rsvp-status-modal" value="Hadir" />
          </div>
        </div>
        <!-- ================================================== -->

        <div>
          <label class="mb-1 block pt-2 text-sm">Pesan / Doa (Opsional):</label>
          <textarea
            id="rsvp-message-modal"
            rows="3"
            class="mt-1 block w-full rounded-xl border border-[var(--inv-border)] px-3 py-2"
            placeholder="Tuliskan ucapan dan doa terbaik Anda..."></textarea>
        </div>
      </div>

      <button
        id="send-rsvp-btn-modal"
        class="mt-6 w-full rounded-2xl bg-lime-600 px-4 py-3 text-sm font-bold text-white hover:bg-lime-700"
      >
        <i class="fa-solid fa-envelope-circle-check mr-2"></i> Kirim Konfirmasi
      </button>

      <button
        onclick="closeModal('rsvp-form-modal')"
        class="mx-auto mt-3 text-xs">Batal</button
      >

      <div
        id="rsvp-messages-container"
        class="mt-6 max-h-80 min-h-80 overflow-y-auto rounded-lg border border-gray-200 bg-gray-50 p-3"
      >
        <div id="rsvp-messages" class="flex flex-col space-y-2"></div>
      </div>

      <button
        id="load-more-btn"
        class="mt-2 text-sm text-lime-600 hover:underline"
        >Lihat lebih banyak</button
      >
    </div>

    <div
      id="success-toast"
      class="fixed right-5 bottom-5 z-[500] hidden translate-x-full transform rounded-xl p-4 shadow-2xl transition-all duration-300"
      style="background:#22c55e;color:white;"
    >
      <div class="flex items-center">
        <i class="fas fa-check-circle mr-3 text-xl"></i>
        <span class="text-sm font-bold">Konfirmasi berhasil dikirim!</span>
      </div>
    </div>
  </div>
</div>

<!-- ========================== CSS DROPDOWN ========================== -->
<style>
  .custom-select-wrapper {
    width: 100%;
    position: relative;
  }

  .custom-select-display {
    background: rgba(255, 255, 255, 0.25);
    backdrop-filter: blur(10px);
    padding: 12px 16px;
    font-size: 15px;
    font-weight: 600;
    color: #3a3a3a;
    display: flex;
    justify-content: space-between;
    align-items: center;
    cursor: pointer;
    transition: 0.25s;
  }

  .custom-select-display:hover {
    background: rgba(255, 255, 255, 0.4);
  }

  .arrow-icon {
    transition: transform 0.25s;
  }

  .custom-select-options {
    position: absolute;
    top: 110%;
    width: 100%;
    left: 0;

    background: rgba(255, 255, 255, 0.75);
    backdrop-filter: blur(12px);

    border: 1px solid rgba(213, 180, 155, 0.4);
    border-radius: 12px;

    padding: 6px 0;
    box-shadow: 0 5px 18px rgba(0, 0, 0, 0.15);

    animation: fadeDropdown 0.18s ease;
    z-index: 99;
  }

  @keyframes fadeDropdown {
    from {
      opacity: 0;
      transform: translateY(-5px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  .option-item {
    padding: 10px 16px;
    font-size: 15px;
    cursor: pointer;
    transition: 0.2s;
    font-weight: 600;
    color: #4b4b4b;
  }

  .option-item:hover {
    background: rgba(213, 180, 155, 0.2);
    color: var(--inv-accent);
    border-radius: 8px;
  }
</style>

<!-- ========================== SCRIPT ========================== -->
<script>
  import { firebase, db } from '~/data/firebase.js'

  window.getGuestNameFromUrl = function () {
    const params = new URLSearchParams(window.location.search)
    let name = params.get('to')

    if (!name || name === null || name.trim() === '') {
      return 'Tamu Undangan'
    }

    // Normalize
    name = String(name).trim().replace(/\+/g, ' ').replace(/-/g, ' ')

    // Jika aneh, fallback
    if (!name || name.trim() === '') return 'Tamu Undangan'

    return name
  }

  window.showSuccessToast = function () {
    const toast = document.getElementById('success-toast')
    if (!toast) return

    toast.classList.remove('hidden')
    requestAnimationFrame(() => {
      toast.classList.remove('translate-x-full')
    })

    setTimeout(() => {
      toast.classList.add('translate-x-full')
      setTimeout(() => toast.classList.add('hidden'), 300)
    }, 3000)
  }

  document.addEventListener('DOMContentLoaded', () => {
    const display = document.getElementById('status-dropdown')
    const options = document.getElementById('status-options')
    const text = document.getElementById('status-text')
    const hiddenInput = document.getElementById('rsvp-status-modal')
    const arrow = display.querySelector('.arrow-icon')

    display.addEventListener('click', () => {
      options.classList.toggle('hidden')
      arrow.style.transform = options.classList.contains('hidden')
        ? 'rotate(0deg)'
        : 'rotate(180deg)'
    })

    document.querySelectorAll('.option-item').forEach((opt) => {
      opt.addEventListener('click', () => {
        const value = opt.dataset.value
        hiddenInput.value = value
        text.textContent = value

        options.classList.add('hidden')
        arrow.style.transform = 'rotate(0deg)'
      })
    })

    document.addEventListener('click', (e) => {
      if (!display.contains(e.target) && !options.contains(e.target)) {
        options.classList.add('hidden')
        arrow.style.transform = 'rotate(0deg)'
      }
    })
  })

  let allMessages = []
  let visibleCount = 6

  document.addEventListener('DOMContentLoaded', () => {
    const formBtn = document.getElementById('send-rsvp-btn-modal')
    const messagesDiv = document.getElementById('rsvp-messages')
    const nameInput = document.getElementById('rsvp-name-modal')
    const loadMoreBtn = document.getElementById('load-more-btn')
    const rsvpGreetingName = document.getElementById('rsvp-greeting-name')
    const rsvpStatusModal = document.getElementById('rsvp-status-modal')
    const rsvpMessageModal = document.getElementById('rsvp-message-modal')

    const guestName = window.getGuestNameFromUrl()
    rsvpGreetingName.textContent = guestName
    nameInput.value = guestName

    formBtn.addEventListener('click', () => {
      db.ref('rsvp').push({
        name: nameInput.value.trim() || 'Tamu Undangan',
        status: rsvpStatusModal.value,
        message: rsvpMessageModal.value,
        count: 1,
        timestamp: Date.now(),
      })

      window.showSuccessToast()
      rsvpMessageModal.value = ''
    })

    /* ===============================
       RENDER RSVP MESSAGES
    =============================== */
    function renderMessages() {
      if (!messagesDiv) return

      messagesDiv.innerHTML = ''
      const messagesToShow = allMessages
        .slice()
        .reverse()
        .slice(0, visibleCount)

      messagesToShow.forEach((data) => {
        const isHadir = data.status === 'Hadir'

        const wrapper = document.createElement('div')
        wrapper.className = `
          flex items-end mb-3 
          ${isHadir ? 'justify-start' : 'justify-end'}
          opacity-0 translate-y-3
        `

        const avatar = document.createElement('div')
        avatar.innerText = data.name.charAt(0).toUpperCase()
        avatar.className = `
          w-8 h-8 rounded-full flex items-center justify-center
          text-white font-semibold shadow 
          bg-gray-400 flex-shrink-0
        `

        const time = new Date(data.timestamp)
        const hh = time.getHours().toString().padStart(2, '0')
        const mm = time.getMinutes().toString().padStart(2, '0')

        const bubble = document.createElement('div')
        bubble.className = `
          relative px-4 py-2 rounded-lg shadow max-w-[75%] w-fit break-words
          ${isHadir ? 'bg-lime-100 text-left rounded-bl-none' : 'bg-red-100 text-right rounded-br-none'}
        `

        bubble.innerHTML = `
          <div class="text-xs text-gray-500 font-semibold mb-1">
            ${data.name} • ${hh}:${mm}
          </div>
          <div class="text-sm mb-1">${data.message || '<i>Tidak ada pesan</i>'}</div>
          <div class="text-xs text-gray-600">Status: ${data.status}</div>
        `

        if (isHadir) {
          wrapper.appendChild(avatar)
          wrapper.appendChild(bubble)
        } else {
          wrapper.appendChild(bubble)
          wrapper.appendChild(avatar)
        }

        messagesDiv.appendChild(wrapper)

        requestAnimationFrame(() => {
          wrapper.style.transition = 'all 0.25s ease'
          wrapper.style.opacity = 1
          wrapper.style.transform = 'translateY(0)'
        })
      })

      messagesDiv.scrollTop = messagesDiv.scrollHeight
    }

    /* LISTENER FIREBASE */
    if (messagesDiv) {
      db.ref('rsvp')
        .orderByChild('timestamp')
        .on('value', (snapshot) => {
          const data = snapshot.val() || {}
          allMessages = Object.values(data).sort(
            (a, b) => a.timestamp - b.timestamp,
          )
          renderMessages()
        })
    }

    loadMoreBtn.addEventListener('click', () => {
      visibleCount += 6
      renderMessages()
    })

    function cleanupOldMessages() {
      const now = Date.now()
      const ONE_MONTH = 2592000000 // 30 hari

      db.ref('rsvp').once('value', (snapshot) => {
        const data = snapshot.val() || {}

        Object.entries(data).forEach(([key, msg]) => {
          if (now - msg.timestamp > ONE_MONTH) {
            db.ref('rsvp/' + key).remove()
          }
        })
      })
    }
  })
</script>
